name: Multi-Repo Integration

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  count_pending_prs:
    runs-on: ubuntu-latest
    outputs:
      repo_info: ${{ steps.parse_manifest.outputs.repo_info }}  # Sortie avec les infos des repos (nom et branche)

    steps:
      - name: Checkout Coordinator Repo
        uses: actions/checkout@v4

      - name: Parse Integration Manifest and Count Repositories in Pending Changesets
        id: parse_manifest
        run: |
          # Extract repository info as a JSON array
          REPO_INFO=$(yq eval '.changesets[0].repositories | map({repo: .name, branch: .ref}) | @json' integration.yaml)

          # Output the repository info to pass to the next job
          echo "REPO_INFO_JSON=${REPO_INFO}" >> $GITHUB_ENV

          # Set repo_info as an output
          echo "repo_info=${REPO_INFO}" >> $GITHUB_OUTPUT

      - name: Verify Repo Info
        run: |
          # Verify the REPO_INFO output
          echo "Repo Info: ${{ steps.parse_manifest.outputs.repo_info }}"

  build_repositories:
    runs-on: ubuntu-latest
    needs: count_pending_prs  # Ce job dépend du job count_pending_prs
    strategy:
      matrix:
        repo_info: ${{ fromJson(needs.count_pending_prs.outputs.repo_info) }}  # Utilisation de l'output du job précédent pour créer la matrice
    steps:
      - name: Checkout Repository for PR
        run: |
          # Get the repository and branch from the matrix values
          REPO_NAME=${{ matrix.repo_info.repo }}  # Nom du dépôt
          REPO_BRANCH=${{ matrix.repo_info.branch }}  # Branche du dépôt

          # Checkout the repository with the appropriate branch
          echo "Checking out repository $REPO_NAME on branch $REPO_BRANCH"
          git clone "https://github.com/your-org/$REPO_NAME.git"
          cd $REPO_NAME
          git checkout $REPO_BRANCH
    
      - name: Build Repository
        run: |
          echo "Running build for repository ${{ matrix.repo_info.repo }} on branch ${{ matrix.repo_info.branch }}"
          # Add your build commands here