name: Multi-Repo Integration

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  count_pending_prs:
    runs-on: ubuntu-latest
    outputs:
      PR_COUNT: ${{ steps.parse_manifest.outputs.PR_COUNT }}  # On définit la sortie du job pour l'utiliser dans le job suivant

    steps:
      - name: Checkout Coordinator Repo
        uses: actions/checkout@v4

      - name: Parse Integration Manifest and Count Repositories in Pending Changesets
        id: parse_manifest
        run: |
          # Extract and count the number of PRs in the pending changeset
          PR_COUNT=$(yq eval '.changesets[0].repositories | length' integration.yaml)

          # Output the result
          echo "Number of PRs in pending changeset: $PR_COUNT"

          # Set PR_COUNT as an output for use in the next job
          echo "PR_COUNT=$PR_COUNT" >> $GITHUB_OUTPUT

      - name: Verify PR Count
        run: |
          # Verify the PR_COUNT output
          echo "PR_COUNT: ${{ steps.parse_manifest.outputs.PR_COUNT }}"

  build_repositories:
    runs-on: ubuntu-latest
    needs: count_pending_prs  # Ce job dépend du job count_pending_prs
    strategy:
      matrix:
        pr_index: ${{ fromJSON(format('[{}]', join(', ', range(0, needs.count_pending_prs.outputs.PR_COUNT | int)))) }}  # Utilisation de needs pour la sortie du job précédent
    steps:
      - name: Echo Test
        run: |
          echo "Running build for PR index: ${{ matrix.pr_index }}"
          echo "test"
